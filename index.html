<!DOCTYPE html><html lang="en"><head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .chat-message {
            display: flex;
            align-items: flex-end;
            margin-bottom: 8px;
            word-break: break-word;
        }
        .chat-bubble {
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: background 0.2s;
        }
        .chat-bubble.user {
            background: linear-gradient(90deg, #34d399 0%, #10b981 100%);
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .chat-bubble.bot {
            background: linear-gradient(90deg, #374151 0%, #6b7280 100%);
            color: #fff;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin: 0 10px;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        .spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-top-color: #34d399;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #chatbox::-webkit-scrollbar {
            width: 8px;
        }
        #chatbox::-webkit-scrollbar-track {
            background-color: #F3F4F6;
        }
        #chatbox::-webkit-scrollbar-thumb {
            background-color: #6B7280;
            border-radius: 4px;
        }
        .glass {
            background: rgba(31,41,55,0.7);
            backdrop-filter: blur(8px);
            border-radius: 24px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
        }
        .input-area {
            background: rgba(55,65,81,0.85);
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        .input-area input {
            background: transparent;
            border: none;
            outline: none;
        }
        .input-area button {
            transition: background 0.2s, color 0.2s;
        }
        .input-area button:hover {
            background: #34d399;
            color: #fff;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen w-screen h-screen overflow-hidden">
    <div class="flex h-screen w-screen">
        <aside class="bg-gray-800 w-64 flex flex-col py-8 px-4 border-r border-gray-700 relative">
            <div class="flex items-center mb-8">
                <img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" alt="AI Avatar" class="avatar mr-2">
                <span class="text-xl font-bold text-green-400">EMERGENT.AI</span>
            </div>
            <button id="newChatBtn" class="mb-4 py-2 px-4 bg-green-500 text-white rounded font-semibold hover:bg-green-400 transition"><i class="fas fa-plus mr-2"></i>New Chat</button>
            <div class="flex-1 overflow-y-auto">
                <h3 class="text-gray-400 text-sm mb-2">Previous Chats</h3>
                <ul id="chatList" class="space-y-2"></ul>
            </div>
            <div class="absolute left-0 bottom-0 w-full p-3 mb-16">
                <div class="bg-gray-900 bg-opacity-90 text-gray-200 text-xs rounded-lg p-3 border border-gray-700 shadow">
                    <div class="font-bold text-green-400 mb-1"><i class="fas fa-info-circle mr-1"></i>How to use:</div>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Type your message and press <b>Send</b> or Enter.</li>
                        <li>To generate an image, type <b>/image</b> followed by your description.</li>
                        <li>Start a new chat with <b>New Chat</b> and give it a custom name.</li>
                        <li>Rename or delete chats from the sidebar.</li>
                        <li>Click an image to view or download it.</li>
                    </ul>
                </div>
            </div>
        </aside>
        <main class="flex-1 flex flex-col h-screen">
            <div class="glass flex flex-col h-full w-full py-8 px-6 rounded-none shadow-lg border border-gray-800 relative">
                <div id="chatbox" class="flex flex-col h-full overflow-y-scroll pb-16 flex-grow mb-20 space-y-2" style="min-height: 320px;"></div>
                <div class="absolute bottom-0 left-0 w-full input-area py-2 px-4" style="z-index: 10;">
                    <form id="chatForm">
                        <div class="flex w-full items-center">
                            <button id="infoButton" type="button" class="rounded-full bg-gray-700 text-white border border-gray-600 px-4 mr-2 relative" onclick="showInfoPopup(event)">
                                <div id="infoTooltip" class="absolute hidden -left-40 bottom-full mb-2 bg-gray-700 text-white text-xs p-2 rounded-lg shadow" style="width: 200px;">Simply ask for an image by describing it or type <strong>/image</strong> followed by the description to generate an image.</div>
                                <i class="fas fa-image"></i>
                            </button>
                            <input id="chatInput" type="text" class="w-full py-2 px-4 rounded bg-transparent text-white border-none focus:ring-0" placeholder="Type your message">
                            <button id="sendButton" class="ml-2 rounded-full bg-green-500 text-white font-bold px-4 py-2 shadow-lg hover:bg-green-400 transition"> <i class="fas fa-paper-plane"></i> </button>
                        </div>
                    </form>
                </div>
                <div class="spinner absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20"></div>
            </div>
        </main>
    </div>

    <script>
        function displayLargeImage(imageUrl) {
            const largeImageContainer = document.createElement('div');
            largeImageContainer.className = 'fixed top-0 left-0 w-screen p-2 h-screen bg-black bg-opacity-70 flex justify-center items-center z-30';
            largeImageContainer.onclick = (e) => {
                e.stopPropagation();
                largeImageContainer.remove();
            }

            const largeImage = document.createElement('img');
            largeImage.src = imageUrl;
            largeImage.className = 'max-w-full max-h-full rounded-lg';

            const downloadLargeButton = document.createElement("button");
            downloadLargeButton.innerHTML = "Download";
            downloadLargeButton.className = "absolute bottom-6 md:bottom-10 left-1/2 p-2 text-white rounded bg-green-500 bg-opacity-80 hover:bg-opacity-100 transform -translate-x-1/2";
            downloadLargeButton.onclick = (e) => {
              e.stopPropagation();
              const a = document.createElement('a');
              a.href = imageUrl;
              a.download = 'generated-image.png';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            };

            const closeButton = document.createElement('button');
            closeButton.innerHTML = '<i class="fas fa-times"></i>';
            closeButton.className = 'absolute top-6 right-6 p-2 text-red-500 rounded-full bg-opacity-80 hover:bg-opacity-100';
            closeButton.onclick = (e) => {
              e.stopPropagation();
              largeImageContainer.remove();
            };

            largeImageContainer.appendChild(largeImage);
            largeImageContainer.appendChild(downloadLargeButton);
            largeImageContainer.appendChild(closeButton);
            document.body.appendChild(largeImageContainer);
        }
        const chatForm = document.getElementById("chatForm");
        const sendButton = document.getElementById("sendButton");
        const chatInput = document.getElementById('chatInput');
        chatInput.focus();
        const chatbox = document.getElementById('chatbox');
        const spinner = document.querySelector('.spinner');

        // Chat history management
        let chatHistory = [];
        let currentChatIndex = null;

        function displayMessage(message, isUser) {
            const msgElem = document.createElement('div');
            msgElem.className = 'chat-message ' + (isUser ? 'justify-end' : 'justify-start');
            if (isUser) {
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble user';
                bubble.textContent = message;
                msgElem.appendChild(bubble);
                const avatar = document.createElement('img');
                // User avatar icon (change to a user icon)
                avatar.src = 'https://cdn-icons-png.flaticon.com/512/1077/1077012.png';
                avatar.alt = 'User';
                avatar.className = 'avatar ml-2';
                msgElem.appendChild(avatar);
            } else {
                const avatar = document.createElement('img');
                avatar.src = 'https://cdn-icons-png.flaticon.com/512/4712/4712027.png';
                avatar.alt = 'Bot';
                avatar.className = 'avatar mr-2';
                msgElem.appendChild(avatar);
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble bot';
                bubble.textContent = message;
                msgElem.appendChild(bubble);
            }
            chatbox.appendChild(msgElem);
            chatbox.scrollTop = chatbox.scrollHeight;
            // Save to history
            if (currentChatIndex !== null) {
                chatHistory[currentChatIndex].messages.push({ message, isUser });
                saveChatHistory();
            }
        }

        function renderChat(chatIndex) {
            chatbox.innerHTML = '';
            if (chatHistory[chatIndex]) {
                chatHistory[chatIndex].messages.forEach(msg => {
                    displayMessage(msg.message, msg.isUser);
                });
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderChatList();
        }

        function loadChatHistory() {
            const stored = localStorage.getItem('chatHistory');
            if (stored) {
                chatHistory = JSON.parse(stored);
            }
            renderChatList();
        }

        function renderChatList() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            chatHistory.forEach((chat, idx) => {
                const li = document.createElement('li');
                li.className = 'bg-gray-700 text-white rounded px-3 py-2 flex items-center justify-between cursor-pointer hover:bg-green-500 transition group';
                // Chat title span (editable)
                const titleSpan = document.createElement('span');
                titleSpan.textContent = chat.title || `Chat ${idx + 1}`;
                titleSpan.className = 'flex-1 truncate';
                titleSpan.title = 'Click to rename';
                titleSpan.onclick = (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = chat.title || `Chat ${idx + 1}`;
                    input.className = 'bg-gray-800 text-white px-2 py-1 rounded w-full';
                    input.onblur = () => {
                        chatHistory[idx].title = input.value.trim() || `Chat ${idx + 1}`;
                        saveChatHistory();
                    };
                    input.onkeydown = (ev) => {
                        if (ev.key === 'Enter') {
                            input.blur();
                        }
                    };
                    li.replaceChild(input, titleSpan);
                    input.focus();
                    input.select();
                };
                li.appendChild(titleSpan);
                // Delete button
                const delBtn = document.createElement('button');
                delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                delBtn.className = 'ml-2 text-red-400 opacity-0 group-hover:opacity-100 transition-opacity px-2 py-1 rounded hover:bg-red-700';
                delBtn.title = 'Delete chat';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('Delete this chat?')) {
                        chatHistory.splice(idx, 1);
                        if (chatHistory.length === 0) {
                            startNewChat();
                        } else {
                            currentChatIndex = Math.max(0, idx - 1);
                        }
                        saveChatHistory();
                        renderChat(currentChatIndex);
                    }
                };
                li.appendChild(delBtn);
                li.onclick = () => {
                    currentChatIndex = idx;
                    renderChat(idx);
                };
                chatList.appendChild(li);
            });
        }

        function startNewChat() {
            let title = prompt('Enter a name for this chat:', `Chat ${chatHistory.length + 1}`);
            if (title === null) return; // Cancelled
            title = title.trim() || `Chat ${chatHistory.length + 1}`;
            chatHistory.push({ title, messages: [] });
            currentChatIndex = chatHistory.length - 1;
            saveChatHistory();
            renderChat(currentChatIndex);
        }

        document.getElementById('newChatBtn').addEventListener('click', () => {
            startNewChat();
        });

        // On load
        loadChatHistory();
        if (chatHistory.length === 0) {
            startNewChat();
        } else {
            currentChatIndex = 0;
            renderChat(currentChatIndex);
        }

        async function callApi(apiUrl, prompt, prependPersona = false) {
            if (prependPersona) {
                prompt = "Follow instructions precisely! If the user asks to generate, create or make an image, photo, or picture by describing it, You will reply with '/image' + description. Otherwise, You will respond normally. Avoid additional explanations." + prompt;
            }
            chatInput.value = apiUrl === "https://backend.buildpicoapps.com/aero/run/image-generation-api?pk=v1-Z0FBQUFBQnBuSXNPcFVMNlY5Q1czc0VsUVhJSjRHYWEwNlJmbmlSUV9uenZ6NlJHRUlFSTgxSkN0cTRqQXZGYTloUHpaaXBWNFVtUjI4S2dKYXVuQnhXVlQtTjZHdjNUWmc9PQ==" ? "Generating..." : "Typing...";
            chatInput.disabled = true;
            sendButton.disabled = true;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({prompt})
            });

            chatInput.value = "";
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
            return response.json();
        }

        function handleError(error) {
            console.error('Error:', error);
            displayMessage('An error occurred. Please try again.', false);
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;

            displayMessage(message, true);
            chatInput.value = '';

            const apiUrl = message.startsWith('/image') ? 'https://backend.buildpicoapps.com/aero/run/image-generation-api?pk=v1-Z0FBQUFBQnBuSXNPcFVMNlY5Q1czc0VsUVhJSjRHYWEwNlJmbmlSUV9uenZ6NlJHRUlFSTgxSkN0cTRqQXZGYTloUHpaaXBWNFVtUjI4S2dKYXVuQnhXVlQtTjZHdjNUWmc9PQ=='
                                                      : 'https://backend.buildpicoapps.com/aero/run/llm-api?pk=v1-Z0FBQUFBQnBuSXNPcFVMNlY5Q1czc0VsUVhJSjRHYWEwNlJmbmlSUV9uenZ6NlJHRUlFSTgxSkN0cTRqQXZGYTloUHpaaXBWNFVtUjI4S2dKYXVuQnhXVlQtTjZHdjNUWmc9PQ==';

            try {
                const prependPersona = apiUrl === 'https://backend.buildpicoapps.com/aero/run/llm-api?pk=v1-Z0FBQUFBQnBuSXNPcFVMNlY5Q1czc0VsUVhJSjRHYWEwNlJmbmlSUV9uenZ6NlJHRUlFSTgxSkN0cTRqQXZGYTloUHpaaXBWNFVtUjI4S2dKYXVuQnhXVlQtTjZHdjNUWmc9PQ==';
                const data = await callApi(apiUrl, message.startsWith('/image') ? message.substring(6).trim() : message, prependPersona);
                if (data.status === 'success') {
                    if (message.toLowerCase().startsWith('/image')) {
                        handleImageResponse(data);
                    } else {
                        if (data.text.trim().toLowerCase().startsWith('/image')) {
                            const imageDescription = data.text.substring(data.text.toLowerCase().indexOf('/image') + 6).trim();
                            const imageData = await callApi('https://backend.buildpicoapps.com/aero/run/image-generation-api?pk=v1-Z0FBQUFBQnBuSXNPcFVMNlY5Q1czc0VsUVhJSjRHYWEwNlJmbmlSUV9uenZ6NlJHRUlFSTgxSkN0cTRqQXZGYTloUHpaaXBWNFVtUjI4S2dKYXVuQnhXVlQtTjZHdjNUWmc9PQ==', imageDescription, false);
                            handleImageResponse(imageData);
                        } else {
                            displayMessage(data.text, false);
                        }
                    }
                } else {
                    handleError(data);
                }

                function handleImageResponse(imageData) {
                    if (imageData.status === 'success') {
                        const imageMsg = document.createElement('div');
                        imageMsg.className = 'chat-message justify-start';
                        const avatar = document.createElement('img');
                        avatar.src = 'https://cdn-icons-png.flaticon.com/512/4712/4712027.png';
                        avatar.alt = 'Bot';
                        avatar.className = 'avatar mr-2';
                        imageMsg.appendChild(avatar);
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'relative w-48 h-48 bg-center border-4 rounded-xl border-gray-700 bg-cover';
                        imageContainer.style.backgroundImage = `url(${imageData.imageUrl})`;
                        imageContainer.onclick = (e) => {
                            e.stopPropagation();
                            displayLargeImage(imageData.imageUrl);
                        }
                        const downloadButton = document.createElement('button');
                        downloadButton.innerHTML = '<i class="fas fa-download"></i>';
                        downloadButton.className = 'absolute bottom-0 right-0 p-2 text-yellow-500 rounded-tl hover:bg-blue-500 hover:text-white';
                        downloadButton.onclick = (e) => {
                          e.stopPropagation();
                          const a = document.createElement('a');
                          a.href = imageData.imageUrl;
                          a.download = 'generated-image.png';
                          document.body.appendChild(a);
                          a.click();
                          document.body.removeChild(a);
                        };
                        imageContainer.appendChild(downloadButton);
                        imageMsg.appendChild(imageContainer);
                        chatbox.appendChild(imageMsg);
                        chatbox.scrollTop = chatbox.scrollHeight;
                        // Save to history
                        if (currentChatIndex !== null) {
                            chatHistory[currentChatIndex].messages.push({ message: '[image]', isUser: false, imageUrl: imageData.imageUrl });
                            saveChatHistory();
                        }
                    } else {
                        handleError(imageData);
                    }
                }
            } catch (error) {
                handleError(error);
            }
        });

        function showInfoPopup(e) {
          e.preventDefault();
          const tooltip = document.getElementById("infoTooltip");
          if (tooltip.classList.contains("hidden")) {
            tooltip.classList.remove("hidden");
          } else {
            tooltip.classList.add("hidden");
          }
          
        }

    </script>


